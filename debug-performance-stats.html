<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Stats Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #d1ecf1; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>
<body>
    <h1>üîß Performance Stats Debug Tool</h1>
    
    <div class="debug-section info">
        <h3>üìã Debug Instructions</h3>
        <p>1. Load the Chrome extension and ensure the dashboard is accessible</p>
        <p>2. Generate some activity (browse websites, trigger network requests)</p>
        <p>3. Use the buttons below to debug the performance monitoring system</p>
        <p>4. Check console logs for detailed information</p>
    </div>

    <div class="debug-section">
        <h3>üéØ Performance Stats Debug</h3>
        <button onclick="debugPerformanceStats()">Debug Performance Stats</button>
        <button onclick="generateTestData()">Generate Test Data</button>
        <button onclick="testStorageOperations()">Test Storage Operations</button>
        <div id="debugResult"></div>
    </div>

    <script>
        // Debug performance stats endpoint
        async function debugPerformanceStats() {
            const resultDiv = document.getElementById('debugResult');
            resultDiv.innerHTML = '<p>üîç Debugging performance stats...</p>';
            
            try {
                console.log('üîç Requesting performance stats from background...');
                
                // Request stats from background script
                const response = await new Promise((resolve) => {
                    if (typeof chrome !== 'undefined' && chrome.runtime) {
                        chrome.runtime.sendMessage(
                            { action: 'getPerformanceStats' },
                            (response) => {
                                console.log('üìä Raw response from background:', response);
                                resolve(response);
                            }
                        );
                    } else {
                        resolve({
                            success: false,
                            error: 'Chrome extension API not available. Test in extension context.'
                        });
                    }
                });

                console.log('üìä Performance stats response:', response);

                if (response && response.success && response.data) {
                    const stats = response.data;
                    
                    // Detailed breakdown
                    const breakdown = {
                        totalOperations: stats.totalOperations,
                        averageOperationTime: stats.averageOperationTime,
                        memoryUsage: stats.memoryUsage,
                        storageSize: stats.storageSize,
                        operationCounts: stats.operationCounts,
                        operationTimesCount: Object.keys(stats.operationTimes || {}).length,
                        uptime: stats.uptime,
                        lastReset: new Date(stats.lastReset)
                    };

                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Performance Stats Retrieved Successfully</h4>
                            <div class="grid">
                                <div>
                                    <h5>üìä Summary:</h5>
                                    <pre>${JSON.stringify(breakdown, null, 2)}</pre>
                                </div>
                                <div>
                                    <h5>üîß Raw Data:</h5>
                                    <pre>${JSON.stringify(stats, null, 2)}</pre>
                                </div>
                            </div>
                            
                            <h5>üéØ Key Metrics:</h5>
                            <ul>
                                <li><strong>Total Operations:</strong> ${stats.totalOperations}</li>
                                <li><strong>Memory Usage:</strong> ${formatBytes(stats.memoryUsage.current)} (Peak: ${formatBytes(stats.memoryUsage.peak)})</li>
                                <li><strong>Storage Size:</strong> ${formatBytes(stats.storageSize.total)}</li>
                                <li><strong>Average Operation Time:</strong> ${stats.averageOperationTime.toFixed(2)}ms</li>
                                <li><strong>Uptime:</strong> ${(stats.uptime / 1000 / 60).toFixed(1)} minutes</li>
                            </ul>
                            
                            ${stats.totalOperations === 0 ? 
                                '<div class="info"><p>‚ö†Ô∏è No operations recorded yet. Try generating some test data or using the extension.</p></div>' : 
                                '<div class="success"><p>‚úÖ Performance tracking is working correctly!</p></div>'
                            }
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Performance Stats Debug Failed</h4>
                            <p><strong>Response:</strong> ${JSON.stringify(response, null, 2)}</p>
                            <p><strong>Error:</strong> ${response?.error || 'Unknown error'}</p>
                            
                            <h5>üîß Troubleshooting:</h5>
                            <ul>
                                <li>Ensure the Chrome extension is loaded and active</li>
                                <li>Check that the background script is running</li>
                                <li>Verify the getPerformanceStats endpoint is implemented</li>
                                <li>Look at browser console for additional errors</li>
                            </ul>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Performance stats debug error:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Performance Stats Debug Error</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Stack:</strong> ${error.stack}</p>
                    </div>
                `;
            }
        }

        // Generate test data to trigger performance tracking
        async function generateTestData() {
            const resultDiv = document.getElementById('debugResult');
            resultDiv.innerHTML = '<p>üé≤ Generating test data...</p>';
            
            try {
                const testOperations = [
                    // Network requests
                    ...Array.from({ length: 5 }, (_, i) => ({
                        action: 'storeNetworkRequest',
                        data: {
                            url: `https://test-debug.com/api/endpoint-${i}`,
                            method: 'GET',
                            headers: JSON.stringify({ 'Content-Type': 'application/json' }),
                            payload_size: Math.floor(Math.random() * 5000),
                            status: 200,
                            response_body: JSON.stringify({ debug: true, id: i }),
                            timestamp: Date.now() + i,
                            response_time: Math.floor(Math.random() * 500)
                        }
                    })),
                    // Console errors
                    ...Array.from({ length: 2 }, (_, i) => ({
                        action: 'CONSOLE_ERROR',
                        data: {
                            message: `Debug console error ${i}`,
                            stack_trace: `Error: Debug error ${i}\\n    at debugTest:${i}:1`,
                            timestamp: Date.now() + i,
                            severity: 'error',
                            url: `https://test-debug.com/page-${i}`
                        }
                    }))
                ];

                let successCount = 0;
                let errorCount = 0;

                console.log('üé≤ Sending test operations:', testOperations);

                for (const operation of testOperations) {
                    try {
                        const response = await new Promise((resolve) => {
                            if (typeof chrome !== 'undefined' && chrome.runtime) {
                                chrome.runtime.sendMessage(operation, resolve);
                            } else {
                                resolve({ success: false, error: 'Chrome API not available' });
                            }
                        });

                        if (response && response.success !== false) {
                            successCount++;
                        } else {
                            errorCount++;
                            console.warn('‚ùå Operation failed:', operation.action, response);
                        }
                    } catch (error) {
                        errorCount++;
                        console.error('‚ùå Operation error:', error);
                    }
                }

                // Wait a moment then check stats
                setTimeout(async () => {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Test Data Generation Complete</h4>
                            <p><strong>Operations Sent:</strong> ${testOperations.length}</p>
                            <p><strong>Successful:</strong> ${successCount}</p>
                            <p><strong>Failed:</strong> ${errorCount}</p>
                            <p class="info">üí° Now run "Debug Performance Stats" to see if the operations were tracked.</p>
                        </div>
                    `;
                }, 1000);

            } catch (error) {
                console.error('‚ùå Test data generation error:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Test Data Generation Error</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Test storage operations directly
        async function testStorageOperations() {
            const resultDiv = document.getElementById('debugResult');
            resultDiv.innerHTML = '<p>üß™ Testing storage operations...</p>';
            
            try {
                const tests = [
                    { action: 'getNetworkRequests', description: 'Get Network Requests' },
                    { action: 'getConsoleErrors', description: 'Get Console Errors' },
                    { action: 'getTokenEvents', description: 'Get Token Events' },
                    { action: 'getPerformanceStats', description: 'Get Performance Stats' }
                ];

                const results = [];

                for (const test of tests) {
                    try {
                        const startTime = performance.now();
                        const response = await new Promise((resolve) => {
                            if (typeof chrome !== 'undefined' && chrome.runtime) {
                                chrome.runtime.sendMessage({ action: test.action }, resolve);
                            } else {
                                resolve({ success: false, error: 'Chrome API not available' });
                            }
                        });
                        const duration = performance.now() - startTime;

                        results.push({
                            test: test.description,
                            success: response && response.success !== false,
                            duration: duration.toFixed(2),
                            dataSize: response?.data ? JSON.stringify(response.data).length : 0,
                            error: response?.error || null
                        });
                    } catch (error) {
                        results.push({
                            test: test.description,
                            success: false,
                            duration: 0,
                            dataSize: 0,
                            error: error.message
                        });
                    }
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>üß™ Storage Operations Test Results</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f0f0f0;">
                                    <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Test</th>
                                    <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Status</th>
                                    <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Duration</th>
                                    <th style="border: 1px solid #ccc; padding: 8px; text-align: right;">Data Size</th>
                                    <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Error</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${results.map(result => `
                                    <tr>
                                        <td style="border: 1px solid #ccc; padding: 8px;">${result.test}</td>
                                        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">
                                            ${result.success ? '‚úÖ' : '‚ùå'}
                                        </td>
                                        <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${result.duration}ms</td>
                                        <td style="border: 1px solid #ccc; padding: 8px; text-align: right;">${result.dataSize} bytes</td>
                                        <td style="border: 1px solid #ccc; padding: 8px; font-size: 11px;">${result.error || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

            } catch (error) {
                console.error('‚ùå Storage operations test error:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Storage Operations Test Error</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Utility function
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Performance Stats Debug Tool Loaded');
            
            if (typeof chrome === 'undefined' || !chrome.runtime) {
                document.body.insertAdjacentHTML('beforeend', `
                    <div class="debug-section error">
                        <h3>‚ö†Ô∏è Extension Context Required</h3>
                        <p>This debug tool needs to be run in the context of a Chrome extension.</p>
                        <p>Make sure to load this page from within your extension environment.</p>
                    </div>
                `);
            }
        });
    </script>
</body>
</html>
