<!DOCTYPE html>
<html>
<head>
    <title>Network Noise Filtering Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .legitimate { background-color: #e8f5e8; }
        .noise { background-color: #ffe8e8; }
        #test-results li { margin: 5px 0; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Network Request Filtering Test</h1>
    <p>This page tests both the noise filtering system and request counting accuracy.</p>
    
    <div class="test-section legitimate">
        <h3>âœ… Legitimate Requests (Should be captured)</h3>
        <p>These requests should appear in both the popup counter and dashboard:</p>
        <ul>
            <li>JSONPlaceholder API</li>
            <li>HTTPBin testing service</li>
            <li>GitHub API</li>
        </ul>
    </div>

    <div class="test-section noise">
        <h3>ðŸ”‡ Noise/Telemetry Requests (Should be filtered)</h3>
        <p>These should be filtered out if "Filter telemetry and tracking requests" is enabled:</p>
        <ul>
            <li>AWS WAF telemetry (edge.sdk.awswaf.com)</li>
            <li>Google Analytics</li>
            <li>Facebook Pixel</li>
            <li>CDN health checks</li>
            <li>Various tracking endpoints</li>
        </ul>
    </div>
    
    <div id="status">
        <h2>ðŸ“Š Test Status</h2>
        <ul id="test-results"></ul>
    </div>

    <button onclick="runLegitimateTests()">Run Legitimate API Tests</button>
    <button onclick="runNoiseTests()">Run Noise/Telemetry Tests</button>
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="clearResults()">Clear Results</button>

    <div style="margin-top: 20px; padding: 10px; background-color: #f0f8ff; border: 1px solid #0066cc;">
        <h3>ðŸ“‹ Testing Instructions:</h3>
        <ol>
            <li>Make sure the extension is loaded and network interception is enabled</li>
            <li>Check the current popup counter before running tests</li>
            <li>Run the tests and check:
                <ul>
                    <li>Popup counter should increase for legitimate requests only</li>
                    <li>Dashboard should show legitimate requests but not noise (if filtering enabled)</li>
                    <li>Console should show filtering debug messages</li>
                </ul>
            </li>
            <li>Toggle the "Filter telemetry and tracking requests" setting to see the difference</li>
        </ol>
    </div>

    <script>
        function log(message, type = 'info') {
            const li = document.createElement('li');
            li.className = type;
            li.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            document.getElementById('test-results').appendChild(li);
            console.log(`[TEST] ${message}`);
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        async function makeRequest(url, description, isNoise = false) {
            try {
                log(`Making ${isNoise ? 'NOISE' : 'LEGITIMATE'} request to ${description}...`, 'info');
                const response = await fetch(url, { 
                    mode: 'no-cors',
                    method: 'GET'
                });
                log(`âœ… ${description} request completed (${isNoise ? 'should be filtered' : 'should be captured'})`, 'success');
                return true;
            } catch (error) {
                log(`âŒ ${description} request failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function runLegitimateTests() {
            log('=== Starting LEGITIMATE API tests ===', 'info');
            
            // These should all be captured and counted
            await makeRequest('https://jsonplaceholder.typicode.com/posts/1', 'JSONPlaceholder API');
            await makeRequest('https://httpbin.org/get', 'HTTPBin testing service');
            await makeRequest('https://api.github.com/users/octocat', 'GitHub API');
            
            log('=== Legitimate tests completed ===', 'success');
        }

        async function runNoiseTests() {
            log('=== Starting NOISE/TELEMETRY tests ===', 'info');
            
            // These should be filtered if filterNoise is enabled
            await makeRequest('https://edge.sdk.awswaf.com/collect', 'AWS WAF telemetry', true);
            await makeRequest('https://waf.amazonaws.com/health', 'AWS WAF health check', true);
            await makeRequest('https://www.google-analytics.com/collect', 'Google Analytics', true);
            await makeRequest('https://connect.facebook.net/en_US/fbevents.js', 'Facebook Pixel', true);
            await makeRequest('https://cdn.example.com/health', 'CDN health check', true);
            await makeRequest('https://telemetry.mozilla.org/submit', 'Mozilla telemetry', true);
            await makeRequest('https://stats.wp.com/beacon', 'WordPress stats beacon', true);
            
            log('=== Noise tests completed ===', 'info');
        }

        async function runAllTests() {
            clearResults();
            log('ðŸš€ Starting comprehensive network filtering test...', 'info');
            
            await runLegitimateTests();
            
            // Wait a bit between test sets
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            await runNoiseTests();
            
            log('ðŸŽ‰ All tests completed! Check popup counter and dashboard to verify filtering.', 'success');
        }

        // Auto-run a quick test when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('Page loaded. Extension should intercept requests made from this page.', 'info');
                log('Current popup counter should reflect only legitimate requests (if filtering enabled).', 'info');
            }, 1000);
        });
    </script>
</body>
</html>
