<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Toggle Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-section h3 { margin-top: 0; color: #333; }
        .status-good { background: #d4edda; border-color: #c3e6cb; }
        .status-warning { background: #fff3cd; border-color: #ffeaa7; }
        .status-error { background: #f8d7da; border-color: #f5c6cb; }
        button { margin: 5px; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; margin-top: 10px; }
        .highlight { background: yellow; padding: 2px 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Dashboard Toggle Debug Test</h1>
        <p><strong>Status:</strong> Testing dashboard sidebar toggle functionality after architecture fix.</p>

        <!-- Chrome API Context Check -->
        <div id="apiCheck" class="test-section">
            <h3>1. Chrome API Context Test</h3>
            <p>Checking if dashboard has proper Chrome extension API access...</p>
            <button class="btn-primary" onclick="testChromeAPIs()">Test APIs</button>
            <div id="apiResults" class="log"></div>
        </div>

        <!-- Background Script Communication -->
        <div id="backgroundCheck" class="test-section">
            <h3>2. Background Script Communication</h3>
            <p>Testing message relay through background script...</p>
            <button class="btn-primary" onclick="testBackgroundRelay()">Test Background Relay</button>
            <div id="backgroundResults" class="log"></div>
        </div>

        <!-- Tab Query Test -->
        <div id="tabCheck" class="test-section">
            <h3>3. Tab Query and Toggle Test</h3>
            <p>Testing tab discovery and toggle message flow...</p>
            <button class="btn-primary" onclick="testTabDiscovery()">Discover Tabs</button>
            <button class="btn-warning" onclick="testToggleFlow()">Test Toggle Flow</button>
            <div id="tabResults" class="log"></div>
        </div>

        <!-- Content Script Detection -->
        <div id="contentCheck" class="test-section">
            <h3>4. Content Script Detection</h3>
            <p>Checking if content scripts are active on tabs...</p>
            <button class="btn-primary" onclick="testContentScripts()">Ping Content Scripts</button>
            <div id="contentResults" class="log"></div>
        </div>

        <!-- Live Dashboard Simulation -->
        <div id="dashboardSim" class="test-section">
            <h3>5. Live Dashboard Toggle Simulation</h3>
            <p>Simulating actual dashboard toggle button behavior...</p>
            <select id="tabSelect">
                <option value="">Select a tab to test...</option>
            </select>
            <button class="btn-success" onclick="simulateNetworkToggle()">Toggle Network Logging</button>
            <button class="btn-danger" onclick="simulateErrorToggle()">Toggle Error Logging</button>
            <div id="dashboardResults" class="log"></div>
        </div>

        <!-- Extension Reload Helper -->
        <div id="reloadHelper" class="test-section status-warning">
            <h3>‚ö†Ô∏è Important: Extension Reload Required</h3>
            <p>If you've made recent code changes, you need to reload the extension:</p>
            <ol>
                <li>Go to <code>chrome://extensions/</code></li>
                <li>Find your extension</li>
                <li>Click the reload button (üîÑ)</li>
                <li>Come back and run these tests</li>
            </ol>
            <button class="btn-warning" onclick="checkExtensionReloadStatus()">Check if Reload Needed</button>
            <div id="reloadResults" class="log"></div>
        </div>
    </div>

    <script>
        let discoveredTabs = [];

        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'color: red;' : type === 'success' ? 'color: green;' : type === 'warning' ? 'color: orange;' : '';
            container.innerHTML += `<div style="${colorClass}">[${timestamp}] ${message}</div>`;
            container.scrollTop = container.scrollHeight;
        }

        function clearLog(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function testChromeAPIs() {
            clearLog('apiResults');
            
            // Test chrome.runtime API
            try {
                if (chrome && chrome.runtime && chrome.runtime.sendMessage) {
                    log('apiResults', '‚úÖ chrome.runtime.sendMessage available', 'success');
                } else {
                    log('apiResults', '‚ùå chrome.runtime.sendMessage NOT available', 'error');
                }
            } catch (e) {
                log('apiResults', `‚ùå chrome.runtime error: ${e.message}`, 'error');
            }

            // Test chrome.tabs API
            try {
                if (chrome && chrome.tabs && chrome.tabs.query) {
                    log('apiResults', '‚ö†Ô∏è chrome.tabs.query available (dashboard should use background relay)', 'warning');
                } else {
                    log('apiResults', '‚úÖ chrome.tabs.query NOT available (correct for dashboard context)', 'success');
                }
            } catch (e) {
                log('apiResults', `‚úÖ chrome.tabs access restriction: ${e.message}`, 'success');
            }

            // Test chrome.storage API
            try {
                if (chrome && chrome.storage && chrome.storage.local) {
                    log('apiResults', '‚úÖ chrome.storage.local available', 'success');
                } else {
                    log('apiResults', '‚ùå chrome.storage.local NOT available', 'error');
                }
            } catch (e) {
                log('apiResults', `‚ùå chrome.storage error: ${e.message}`, 'error');
            }

            // Test extension context
            try {
                const manifest = chrome.runtime.getManifest();
                log('apiResults', `‚úÖ Extension context active: ${manifest.name} v${manifest.version}`, 'success');
            } catch (e) {
                log('apiResults', `‚ùå Extension context error: ${e.message}`, 'error');
            }
        }

        async function testBackgroundRelay() {
            clearLog('backgroundResults');
            
            try {
                log('backgroundResults', 'üì° Testing basic background script ping...');
                
                const response = await chrome.runtime.sendMessage({
                    action: 'ping'
                });
                
                if (response && response.success) {
                    log('backgroundResults', '‚úÖ Background script responded to ping', 'success');
                } else {
                    log('backgroundResults', '‚ö†Ô∏è Background script ping response: ' + JSON.stringify(response), 'warning');
                }
            } catch (error) {
                log('backgroundResults', `‚ùå Background script ping failed: ${error.message}`, 'error');
            }

            // Test toggle message format
            try {
                log('backgroundResults', 'üì° Testing toggle message format (without actual tab)...');
                
                const toggleResponse = await chrome.runtime.sendMessage({
                    action: 'toggleTabLogging',
                    tabId: 999999, // Non-existent tab
                    enabled: true
                });
                
                if (toggleResponse) {
                    log('backgroundResults', `‚úÖ Toggle message accepted: ${JSON.stringify(toggleResponse)}`, 'success');
                } else {
                    log('backgroundResults', '‚ö†Ô∏è Toggle message response empty', 'warning');
                }
            } catch (error) {
                log('backgroundResults', `‚ùå Toggle message test failed: ${error.message}`, 'error');
            }
        }

        async function testTabDiscovery() {
            clearLog('tabResults');
            
            try {
                log('tabResults', 'üì° Requesting tab list from background script...');
                
                const response = await chrome.runtime.sendMessage({
                    action: 'getTabs'
                });
                
                if (response && response.tabs) {
                    discoveredTabs = response.tabs;
                    log('tabResults', `‚úÖ Found ${response.tabs.length} tabs`, 'success');
                    
                    // Populate tab selector
                    const tabSelect = document.getElementById('tabSelect');
                    tabSelect.innerHTML = '<option value="">Select a tab to test...</option>';
                    
                    response.tabs.forEach(tab => {
                        if (tab.id && tab.url && !tab.url.startsWith('chrome://')) {
                            const option = document.createElement('option');
                            option.value = tab.id;
                            option.textContent = `Tab ${tab.id}: ${tab.title || tab.url}`;
                            tabSelect.appendChild(option);
                            
                            log('tabResults', `  üìÑ Tab ${tab.id}: ${tab.title || 'No title'} (${tab.url})`, 'info');
                        }
                    });
                } else {
                    log('tabResults', '‚ùå No tabs received from background script', 'error');
                }
            } catch (error) {
                log('tabResults', `‚ùå Tab discovery failed: ${error.message}`, 'error');
            }
        }

        async function testToggleFlow() {
            clearLog('tabResults');
            
            if (discoveredTabs.length === 0) {
                log('tabResults', '‚ö†Ô∏è No tabs discovered yet. Run "Discover Tabs" first.', 'warning');
                return;
            }

            // Find a suitable test tab (not chrome:// or extension pages)
            const testTab = discoveredTabs.find(tab => 
                tab.id && tab.url && 
                !tab.url.startsWith('chrome://') && 
                !tab.url.startsWith('chrome-extension://')
            );

            if (!testTab) {
                log('tabResults', '‚ö†Ô∏è No suitable tabs found for testing', 'warning');
                return;
            }

            log('tabResults', `üéØ Testing toggle flow with Tab ${testTab.id}: ${testTab.title}`);

            try {
                // Test network logging toggle
                log('tabResults', 'üì° Sending network logging toggle...');
                const networkResponse = await chrome.runtime.sendMessage({
                    action: 'toggleTabLogging',
                    tabId: testTab.id,
                    enabled: true
                });

                if (networkResponse && networkResponse.success) {
                    log('tabResults', '‚úÖ Network toggle succeeded', 'success');
                } else {
                    log('tabResults', `‚ö†Ô∏è Network toggle response: ${JSON.stringify(networkResponse)}`, 'warning');
                }

                // Test error logging toggle
                log('tabResults', 'üì° Sending error logging toggle...');
                const errorResponse = await chrome.runtime.sendMessage({
                    action: 'toggleTabErrorLogging',
                    tabId: testTab.id,
                    enabled: true
                });

                if (errorResponse && errorResponse.success) {
                    log('tabResults', '‚úÖ Error toggle succeeded', 'success');
                } else {
                    log('tabResults', `‚ö†Ô∏è Error toggle response: ${JSON.stringify(errorResponse)}`, 'warning');
                }

            } catch (error) {
                log('tabResults', `‚ùå Toggle flow test failed: ${error.message}`, 'error');
            }
        }

        async function testContentScripts() {
            clearLog('contentResults');
            
            if (discoveredTabs.length === 0) {
                log('contentResults', '‚ö†Ô∏è No tabs discovered yet. Run "Discover Tabs" first.', 'warning');
                return;
            }

            log('contentResults', 'üì° Pinging content scripts on all tabs...');

            for (const tab of discoveredTabs) {
                if (tab.id && tab.url && !tab.url.startsWith('chrome://') && !tab.url.startsWith('chrome-extension://')) {
                    try {
                        log('contentResults', `üì° Pinging Tab ${tab.id}...`);
                        
                        const response = await chrome.runtime.sendMessage({
                            action: 'pingTab',
                            tabId: tab.id
                        });

                        if (response && response.success) {
                            log('contentResults', `‚úÖ Tab ${tab.id} content script active`, 'success');
                        } else {
                            log('contentResults', `‚ö†Ô∏è Tab ${tab.id} content script not responding`, 'warning');
                        }
                    } catch (error) {
                        log('contentResults', `‚ùå Tab ${tab.id} ping failed: ${error.message}`, 'error');
                    }
                }
            }
        }

        async function simulateNetworkToggle() {
            const tabSelect = document.getElementById('tabSelect');
            const selectedTabId = parseInt(tabSelect.value);
            
            if (!selectedTabId) {
                log('dashboardResults', '‚ö†Ô∏è Please select a tab first', 'warning');
                return;
            }

            clearLog('dashboardResults');
            log('dashboardResults', `üéØ Simulating network toggle for Tab ${selectedTabId}...`);

            try {
                // Simulate the exact dashboard toggle function
                const response = await chrome.runtime.sendMessage({
                    action: 'toggleTabLogging',
                    tabId: selectedTabId,
                    enabled: true
                });

                if (response && response.success) {
                    log('dashboardResults', '‚úÖ Network logging toggle successful!', 'success');
                    log('dashboardResults', `üìä Response: ${JSON.stringify(response)}`, 'info');
                } else {
                    log('dashboardResults', `‚ùå Network logging toggle failed: ${JSON.stringify(response)}`, 'error');
                }

                // Also update storage like the real dashboard does
                const tabState = {
                    active: true,
                    startTime: Date.now(),
                    requestCount: 0
                };
                
                await chrome.storage.local.set({ [`tabLogging_${selectedTabId}`]: tabState });
                log('dashboardResults', '‚úÖ Storage state updated', 'success');

            } catch (error) {
                log('dashboardResults', `‚ùå Network toggle simulation failed: ${error.message}`, 'error');
            }
        }

        async function simulateErrorToggle() {
            const tabSelect = document.getElementById('tabSelect');
            const selectedTabId = parseInt(tabSelect.value);
            
            if (!selectedTabId) {
                log('dashboardResults', '‚ö†Ô∏è Please select a tab first', 'warning');
                return;
            }

            clearLog('dashboardResults');
            log('dashboardResults', `üéØ Simulating error toggle for Tab ${selectedTabId}...`);

            try {
                // Simulate the exact dashboard toggle function
                const response = await chrome.runtime.sendMessage({
                    action: 'toggleTabErrorLogging',
                    tabId: selectedTabId,
                    enabled: true
                });

                if (response && response.success) {
                    log('dashboardResults', '‚úÖ Error logging toggle successful!', 'success');
                    log('dashboardResults', `üìä Response: ${JSON.stringify(response)}`, 'info');
                } else {
                    log('dashboardResults', `‚ùå Error logging toggle failed: ${JSON.stringify(response)}`, 'error');
                }

                // Also update storage like the real dashboard does
                const tabState = {
                    active: true,
                    startTime: Date.now(),
                    errorCount: 0
                };
                
                await chrome.storage.local.set({ [`tabErrorLogging_${selectedTabId}`]: tabState });
                log('dashboardResults', '‚úÖ Storage state updated', 'success');

            } catch (error) {
                log('dashboardResults', `‚ùå Error toggle simulation failed: ${error.message}`, 'error');
            }
        }

        async function checkExtensionReloadStatus() {
            clearLog('reloadResults');
            
            try {
                // Check if background script has the latest handlers
                log('reloadResults', 'üîç Checking background script version...');
                
                const response = await chrome.runtime.sendMessage({
                    action: 'getVersion'
                });
                
                if (response) {
                    log('reloadResults', `üì¶ Background script response: ${JSON.stringify(response)}`, 'info');
                } else {
                    log('reloadResults', '‚ö†Ô∏è No version response from background script', 'warning');
                }

                // Check if toggle handlers exist
                log('reloadResults', 'üîç Testing toggle handler availability...');
                
                const toggleTest = await chrome.runtime.sendMessage({
                    action: 'toggleTabLogging',
                    tabId: 999999, // Non-existent tab
                    enabled: true
                });
                
                if (toggleTest !== undefined) {
                    log('reloadResults', '‚úÖ Toggle handlers are available in background script', 'success');
                } else {
                    log('reloadResults', '‚ùå Toggle handlers NOT found - Extension reload required!', 'error');
                }

            } catch (error) {
                log('reloadResults', `‚ùå Extension status check failed: ${error.message}`, 'error');
                log('reloadResults', 'üîÑ This likely means extension reload is required', 'warning');
            }
        }

        // Auto-run basic tests on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testChromeAPIs();
                testBackgroundRelay();
            }, 500);
        });
    </script>
</body>
</html>
