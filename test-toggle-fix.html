<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Toggle Quick Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f8ff; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .status-good { background: #d4edda; border-color: #c3e6cb; }
        .status-error { background: #f8d7da; border-color: #f5c6cb; }
        button { margin: 5px; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 150px; overflow-y: auto; margin-top: 10px; border: 1px solid #dee2e6; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        select { padding: 5px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Dashboard Toggle Quick Test</h1>
        <p><strong>Purpose:</strong> Test the specific "Could not establish connection" issue with dashboard toggles.</p>

        <!-- Step 1: Extension Reload Reminder -->
        <div class="test-section status-error">
            <h3>‚ö†Ô∏è Step 1: Reload Extension First!</h3>
            <p>Before running any tests:</p>
            <ol>
                <li>Go to <code>chrome://extensions/</code></li>
                <li>Find your extension and click the reload button (üîÑ)</li>
                <li>Come back and run the tests below</li>
            </ol>
        </div>

        <!-- Step 2: Background Script Test -->
        <div id="backgroundTest" class="test-section">
            <h3>üîç Step 2: Background Script Communication</h3>
            <p>Testing if the background script is responding to messages...</p>
            <button onclick="testBackgroundScript()">Test Background Script</button>
            <div id="backgroundLog" class="log"></div>
        </div>

        <!-- Step 3: Toggle Test -->
        <div id="toggleTest" class="test-section">
            <h3>üéØ Step 3: Toggle Message Test</h3>
            <p>Testing the exact toggle messages that were failing...</p>
            <button onclick="discoverTabs()">1. Discover Tabs</button>
            <select id="tabSelect" style="min-width: 200px;">
                <option value="">Select a tab...</option>
            </select>
            <br>
            <button onclick="testNetworkToggle()">2. Test Network Toggle</button>
            <button onclick="testErrorToggle()">3. Test Error Toggle</button>
            <div id="toggleLog" class="log"></div>
        </div>

        <!-- Step 4: Results -->
        <div id="results" class="test-section">
            <h3>üìä Results Summary</h3>
            <div id="resultsSummary" class="log">Run the tests above to see results...</div>
        </div>
    </div>

    <script>
        let discoveredTabs = [];
        let testResults = {
            backgroundScript: null,
            networkToggle: null,
            errorToggle: null
        };

        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            container.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            container.scrollTop = container.scrollHeight;
        }

        function updateResults() {
            const summary = document.getElementById('resultsSummary');
            let html = '<h4>Test Results:</h4>';
            
            if (testResults.backgroundScript === true) {
                html += '<div class="success">‚úÖ Background Script: Working</div>';
            } else if (testResults.backgroundScript === false) {
                html += '<div class="error">‚ùå Background Script: Failed</div>';
            } else {
                html += '<div>‚è≥ Background Script: Not tested</div>';
            }

            if (testResults.networkToggle === true) {
                html += '<div class="success">‚úÖ Network Toggle: Working</div>';
            } else if (testResults.networkToggle === false) {
                html += '<div class="error">‚ùå Network Toggle: Failed</div>';
            } else {
                html += '<div>‚è≥ Network Toggle: Not tested</div>';
            }

            if (testResults.errorToggle === true) {
                html += '<div class="success">‚úÖ Error Toggle: Working</div>';
            } else if (testResults.errorToggle === false) {
                html += '<div class="error">‚ùå Error Toggle: Failed</div>';
            } else {
                html += '<div>‚è≥ Error Toggle: Not tested</div>';
            }

            if (testResults.backgroundScript === true && testResults.networkToggle === true && testResults.errorToggle === true) {
                html += '<div class="success"><h4>üéâ All Tests Passed! Dashboard toggles should now work.</h4></div>';
            } else if (testResults.backgroundScript === false) {
                html += '<div class="error"><h4>üö® Background script issue - Extension reload needed!</h4></div>';
            }

            summary.innerHTML = html;
        }

        async function testBackgroundScript() {
            document.getElementById('backgroundLog').innerHTML = '';
            log('backgroundLog', 'üîç Testing background script communication...');

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'ping'
                });

                if (response && response.success) {
                    log('backgroundLog', '‚úÖ Background script responded successfully!', 'success');
                    log('backgroundLog', `üì¶ Response: ${JSON.stringify(response)}`, 'info');
                    testResults.backgroundScript = true;
                } else {
                    log('backgroundLog', '‚ùå Background script responded but with unexpected format', 'error');
                    log('backgroundLog', `üì¶ Response: ${JSON.stringify(response)}`, 'warning');
                    testResults.backgroundScript = false;
                }
            } catch (error) {
                log('backgroundLog', `‚ùå Background script communication failed: ${error.message}`, 'error');
                if (error.message.includes('Could not establish connection')) {
                    log('backgroundLog', 'üîÑ This is the exact error we\'re fixing - extension needs reload!', 'error');
                }
                testResults.backgroundScript = false;
            }

            updateResults();
        }

        async function discoverTabs() {
            document.getElementById('toggleLog').innerHTML = '';
            log('toggleLog', 'üîç Discovering available tabs...');

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'getTabs'
                });

                if (response && response.success && response.tabs) {
                    discoveredTabs = response.tabs;
                    log('toggleLog', `‚úÖ Found ${response.tabs.length} suitable tabs`, 'success');

                    const tabSelect = document.getElementById('tabSelect');
                    tabSelect.innerHTML = '<option value="">Select a tab...</option>';

                    response.tabs.forEach(tab => {
                        const option = document.createElement('option');
                        option.value = tab.id;
                        option.textContent = `Tab ${tab.id}: ${tab.title.substring(0, 50)}...`;
                        tabSelect.appendChild(option);
                        log('toggleLog', `üìÑ Found: ${tab.title}`, 'info');
                    });
                } else {
                    log('toggleLog', '‚ùå Failed to discover tabs', 'error');
                    log('toggleLog', `üì¶ Response: ${JSON.stringify(response)}`, 'warning');
                }
            } catch (error) {
                log('toggleLog', `‚ùå Tab discovery failed: ${error.message}`, 'error');
            }
        }

        async function testNetworkToggle() {
            const tabSelect = document.getElementById('tabSelect');
            const selectedTabId = parseInt(tabSelect.value);

            if (!selectedTabId) {
                log('toggleLog', '‚ö†Ô∏è Please discover tabs and select one first', 'warning');
                return;
            }

            log('toggleLog', `üéØ Testing network toggle for Tab ${selectedTabId}...`);

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'toggleTabLogging',
                    tabId: selectedTabId,
                    enabled: true
                });

                if (response && response.success) {
                    log('toggleLog', '‚úÖ Network toggle SUCCESS! No connection error.', 'success');
                    log('toggleLog', `üì¶ Response: ${JSON.stringify(response)}`, 'success');
                    testResults.networkToggle = true;
                } else {
                    log('toggleLog', '‚ùå Network toggle failed', 'error');
                    log('toggleLog', `üì¶ Response: ${JSON.stringify(response)}`, 'error');
                    testResults.networkToggle = false;
                }
            } catch (error) {
                log('toggleLog', `‚ùå Network toggle error: ${error.message}`, 'error');
                if (error.message.includes('Could not establish connection')) {
                    log('toggleLog', 'üö® Still getting connection error - background script issue!', 'error');
                }
                testResults.networkToggle = false;
            }

            updateResults();
        }

        async function testErrorToggle() {
            const tabSelect = document.getElementById('tabSelect');
            const selectedTabId = parseInt(tabSelect.value);

            if (!selectedTabId) {
                log('toggleLog', '‚ö†Ô∏è Please discover tabs and select one first', 'warning');
                return;
            }

            log('toggleLog', `üéØ Testing error toggle for Tab ${selectedTabId}...`);

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'toggleTabErrorLogging',
                    tabId: selectedTabId,
                    enabled: true
                });

                if (response && response.success) {
                    log('toggleLog', '‚úÖ Error toggle SUCCESS! No connection error.', 'success');
                    log('toggleLog', `üì¶ Response: ${JSON.stringify(response)}`, 'success');
                    testResults.errorToggle = true;
                } else {
                    log('toggleLog', '‚ùå Error toggle failed', 'error');
                    log('toggleLog', `üì¶ Response: ${JSON.stringify(response)}`, 'error');
                    testResults.errorToggle = false;
                }
            } catch (error) {
                log('toggleLog', `‚ùå Error toggle error: ${error.message}`, 'error');
                if (error.message.includes('Could not establish connection')) {
                    log('toggleLog', 'üö® Still getting connection error - background script issue!', 'error');
                }
                testResults.errorToggle = false;
            }

            updateResults();
        }

        // Auto-run background test on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testBackgroundScript();
            }, 1000);
        });
    </script>
</body>
</html>
