<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Monitoring Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #d1ecf1; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Performance Monitoring Test</h1>
    
    <div class="test-section info">
        <h3>üîß Setup Instructions</h3>
        <p>1. Load the Chrome extension in developer mode</p>
        <p>2. Open the extension dashboard</p>
        <p>3. Navigate to the "Performance Monitoring" tab (üìä)</p>
        <p>4. Click the test buttons below to verify functionality</p>
    </div>

    <div class="test-section">
        <h3>üìä Storage Analysis Test</h3>
        <button onclick="testStorageAnalysis()">Analyze Current Storage</button>
        <button onclick="testPreExistingData()">Check Pre-existing Data</button>
        <button onclick="simulateOldData()">Simulate Old Data (Test)</button>
        <div id="storageAnalysisResult"></div>
    </div>

    <div class="test-section">
        <h3>üéØ Performance Stats Test</h3>
        <button onclick="testPerformanceStats()">Test Performance Stats API</button>
        <div id="performanceStatsResult"></div>
    </div>

    <div class="test-section">
        <h3>üöÄ Stress Test</h3>
        <button onclick="runStressTest()">Run IndexedDB Stress Test</button>
        <div id="stressTestResult"></div>
    </div>

    <div class="test-section">
        <h3>üíæ Memory Test</h3>
        <button onclick="testMemoryUsage()">Test Memory Usage Tracking</button>
        <div id="memoryTestResult"></div>
    </div>

    <script>
        // Test storage analysis
        async function testStorageAnalysis() {
            const resultDiv = document.getElementById('storageAnalysisResult');
            resultDiv.innerHTML = '<p>Analyzing storage...</p>';
            
            try {
                // Create storage analyzer instance
                const StorageAnalyzer = window.StorageAnalyzer || class {
                    async getDetailedStorageBreakdown() {
                        throw new Error('StorageAnalyzer not available in this context');
                    }
                    async getStorageQuota() {
                        if ('storage' in navigator && 'estimate' in navigator.storage) {
                            const estimate = await navigator.storage.estimate();
                            return {
                                usage: estimate.usage || 0,
                                quota: estimate.quota || 0,
                                usagePercentage: estimate.quota ? ((estimate.usage || 0) / estimate.quota) * 100 : 0,
                                available: (estimate.quota || 0) - (estimate.usage || 0)
                            };
                        }
                        return { usage: 0, quota: 0, usagePercentage: 0, available: 0 };
                    }
                };

                const analyzer = new StorageAnalyzer();
                const [breakdown, quota] = await Promise.all([
                    analyzer.getDetailedStorageBreakdown().catch(e => ({ error: e.message })),
                    analyzer.getStorageQuota()
                ]);

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Storage Analysis Results</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                            <div>
                                <h5>Storage Quota:</h5>
                                <pre>${JSON.stringify(quota, null, 2)}</pre>
                            </div>
                            <div>
                                <h5>Storage Breakdown:</h5>
                                <pre>${JSON.stringify(breakdown, null, 2)}</pre>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Storage Analysis Error</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Check for pre-existing data
        async function testPreExistingData() {
            const resultDiv = document.getElementById('storageAnalysisResult');
            resultDiv.innerHTML = '<p>Checking for pre-existing data...</p>';
            
            try {
                // Open IndexedDB and check for old data
                const dbName = 'ChromeExtensionStorage';
                const request = indexedDB.open(dbName);
                
                request.onsuccess = async (event) => {
                    const db = event.target.result;
                    const storeNames = ['apiCalls', 'consoleErrors', 'tokenEvents', 'minifiedLibraries'];
                    const results = {};
                    
                    for (const storeName of storeNames) {
                        try {
                            const transaction = db.transaction([storeName], 'readonly');
                            const store = transaction.objectStore(storeName);
                            const countRequest = store.count();
                            
                            countRequest.onsuccess = () => {
                                results[storeName] = {
                                    count: countRequest.result,
                                    hasData: countRequest.result > 0
                                };
                                
                                // Check if all stores have been processed
                                if (Object.keys(results).length === storeNames.length) {
                                    const totalRecords = Object.values(results).reduce((sum, r) => sum + r.count, 0);
                                    const hasPreExistingData = totalRecords > 0;
                                    
                                    resultDiv.innerHTML = `
                                        <div class="${hasPreExistingData ? 'info' : 'success'}">
                                            <h4>${hasPreExistingData ? 'üìä' : '‚úÖ'} Pre-existing Data Check</h4>
                                            <p><strong>Total Records:</strong> ${totalRecords}</p>
                                            <p><strong>Status:</strong> ${hasPreExistingData ? 'Pre-existing data found' : 'Clean database'}</p>
                                            <pre>${JSON.stringify(results, null, 2)}</pre>
                                            ${hasPreExistingData ? 
                                                '<p class="info">‚ö†Ô∏è Pre-existing data may affect performance accuracy. Consider clearing data or filtering to new data only.</p>' : 
                                                '<p class="success">‚úÖ Database is clean - performance measurements will be accurate.</p>'
                                            }
                                        </div>
                                    `;
                                }
                            };
                        } catch (storeError) {
                            results[storeName] = { error: storeError.message };
                        }
                    }
                    
                    db.close();
                };
                
                request.onerror = () => {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Database Access Error</h4>
                            <p>Could not access IndexedDB. Make sure you're running in an extension context.</p>
                        </div>
                    `;
                };
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Pre-existing Data Check Error</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Simulate old data for testing
        async function simulateOldData() {
            const resultDiv = document.getElementById('storageAnalysisResult');
            resultDiv.innerHTML = '<p>Simulating old data...</p>';
            
            try {
                // Create test data with old timestamps
                const oldTimestamp = Date.now() - (24 * 60 * 60 * 1000); // 24 hours ago
                const testData = [
                    {
                        action: 'storeNetworkRequest',
                        data: {
                            url: 'https://old-data.test.com/api/endpoint',
                            method: 'GET',
                            headers: JSON.stringify({ 'Content-Type': 'application/json' }),
                            payload_size: 500,
                            status: 200,
                            response_body: JSON.stringify({ data: 'old_test_data' }),
                            timestamp: oldTimestamp,
                            response_time: 150
                        }
                    },
                    {
                        action: 'CONSOLE_ERROR',
                        data: {
                            message: 'Simulated old console error',
                            stack_trace: 'Error: Simulated\\n    at test.js:1:1',
                            timestamp: oldTimestamp,
                            severity: 'error',
                            url: 'https://old-data.test.com/page'
                        }
                    }
                ];

                let successCount = 0;
                for (const item of testData) {
                    if (typeof chrome !== 'undefined' && chrome.runtime) {
                        const response = await new Promise((resolve) => {
                            chrome.runtime.sendMessage(item, resolve);
                        });
                        if (response && response.success !== false) successCount++;
                    } else {
                        // Fallback for testing outside extension context
                        console.log('Would send:', item);
                        successCount++;
                    }
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Old Data Simulation Complete</h4>
                        <p><strong>Records Created:</strong> ${successCount}/${testData.length}</p>
                        <p><strong>Timestamp:</strong> ${new Date(oldTimestamp).toLocaleString()}</p>
                        <p class="info">Now run "Check Pre-existing Data" to see the effect.</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Old Data Simulation Error</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Test performance stats endpoint
        async function testPerformanceStats() {
            const resultDiv = document.getElementById('performanceStatsResult');
            resultDiv.innerHTML = '<p>Testing performance stats API...</p>';
            
            try {
                // Simulate message to background script
                const response = await new Promise((resolve) => {
                    if (typeof chrome !== 'undefined' && chrome.runtime) {
                        chrome.runtime.sendMessage(
                            { action: 'getPerformanceStats' },
                            resolve
                        );
                    } else {
                        // Fallback for testing outside extension context
                        resolve({
                            success: false,
                            error: 'Chrome extension API not available. Test in extension context.'
                        });
                    }
                });

                if (response.success) {
                    const stats = response.data;
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Performance Stats Retrieved Successfully</h4>
                            <pre>${JSON.stringify(stats, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Performance Stats Test Failed</h4>
                            <p>Error: ${response.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Performance Stats Test Error</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Run stress test
        async function runStressTest() {
            const resultDiv = document.getElementById('stressTestResult');
            resultDiv.innerHTML = '<p>Running IndexedDB stress test...</p>';
            
            try {
                const startTime = performance.now();
                
                // Generate test data
                const testRequests = [];
                for (let i = 0; i < 100; i++) {
                    testRequests.push({
                        action: 'storeNetworkRequest',
                        data: {
                            url: `https://api.test.com/endpoint${i}`,
                            method: 'GET',
                            headers: JSON.stringify({ 'Content-Type': 'application/json' }),
                            payload_size: Math.floor(Math.random() * 10000),
                            status: 200,
                            response_body: JSON.stringify({ data: `test_data_${i}` }),
                            timestamp: Date.now() + i,
                            response_time: Math.floor(Math.random() * 1000)
                        }
                    });
                }

                // Send requests in batches
                const batchSize = 10;
                const batches = [];
                for (let i = 0; i < testRequests.length; i += batchSize) {
                    batches.push(testRequests.slice(i, i + batchSize));
                }

                let successCount = 0;
                let errorCount = 0;

                for (const batch of batches) {
                    const batchPromises = batch.map(request => 
                        new Promise((resolve) => {
                            if (typeof chrome !== 'undefined' && chrome.runtime) {
                                chrome.runtime.sendMessage(request, (response) => {
                                    resolve(response ? { success: true } : { success: false });
                                });
                            } else {
                                resolve({ success: false, error: 'Chrome extension API not available' });
                            }
                        })
                    );

                    const results = await Promise.all(batchPromises);
                    results.forEach(result => {
                        if (result.success) successCount++;
                        else errorCount++;
                    });
                }

                const endTime = performance.now();
                const duration = endTime - startTime;

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Stress Test Completed</h4>
                        <p><strong>Total Requests:</strong> ${testRequests.length}</p>
                        <p><strong>Successful:</strong> ${successCount}</p>
                        <p><strong>Failed:</strong> ${errorCount}</p>
                        <p><strong>Duration:</strong> ${duration.toFixed(2)}ms</p>
                        <p><strong>Avg per request:</strong> ${(duration / testRequests.length).toFixed(2)}ms</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Stress Test Error</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Test memory usage
        function testMemoryUsage() {
            const resultDiv = document.getElementById('memoryTestResult');
            
            if ('memory' in performance) {
                const memory = performance.memory;
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Memory Usage Information</h4>
                        <p><strong>Used JS Heap Size:</strong> ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB</p>
                        <p><strong>Total JS Heap Size:</strong> ${(memory.totalJSHeapSize / 1024 / 1024).toFixed(2)} MB</p>
                        <p><strong>JS Heap Size Limit:</strong> ${(memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Memory Information Not Available</h4>
                        <p>performance.memory is not available in this browser/context.</p>
                    </div>
                `;
            }
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Performance Monitoring Test Page Loaded');
            
            // Check if we're in an extension context
            if (typeof chrome === 'undefined' || !chrome.runtime) {
                document.body.insertAdjacentHTML('afterbegin', `
                    <div class="test-section error">
                        <h3>‚ö†Ô∏è Extension Context Required</h3>
                        <p>This test page needs to be run in the context of a Chrome extension to access the runtime APIs.</p>
                        <p>Please load this as part of your extension or open it from the extension dashboard.</p>
                    </div>
                `);
            }
        });
    </script>
</body>
</html>
