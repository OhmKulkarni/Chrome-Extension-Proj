<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test { background: #e3f2fd; border: 1px solid #2196f3; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #fee; border: 1px solid #f88; padding: 15px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .test-btn { background: #2196f3; color: white; }
        .force-btn { background: #ff9800; color: white; }
        pre { background: #f8f8f8; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç IndexedDB Debug Test</h1>
    
    <div class="error">
        <h2>‚ùå Problem: IndexedDB Not Visible in DevTools</h2>
        <p>After the recent fixes, the IndexedDB is no longer showing up in Chrome DevTools Application ‚Üí Storage</p>
        <p><strong>Possible causes:</strong></p>
        <ul>
            <li>Database isn't being created/initialized</li>
            <li>Database is created but has no data</li>
            <li>Our transaction validation changes broke initialization</li>
            <li>Database version or name conflicts</li>
        </ul>
    </div>

    <div class="test">
        <h2>üß™ Debug Steps</h2>
        
        <h3>Step 1: Force Extension to Create Test Data</h3>
        <button class="test-btn" onclick="forceTestData()">Create Test Network Request</button>
        <button class="test-btn" onclick="forceErrorData()">Create Test Console Error</button>
        <button class="force-btn" onclick="checkDatabase()">Check Database Status</button>
        
        <h3>Step 2: Check Console</h3>
        <p>Open DevTools Console (F12) and look for these messages:</p>
        <pre>üîß IndexedDB: Starting database initialization...
‚úÖ IndexedDB: Database opened successfully  
üìä IndexedDB: Available stores: [...]
üîÑ IndexedDB: Database upgrade needed, creating stores...</pre>
        
        <h3>Step 3: Check DevTools Application Tab</h3>
        <p>After creating test data:</p>
        <ol>
            <li>Open DevTools ‚Üí Application ‚Üí Storage</li>
            <li>Look for "IndexedDB" section</li>
            <li>Should see "DevToolsExtension" database</li>
            <li>Should show stores: apiCalls, consoleErrors, tokenEvents, minifiedLibraries</li>
        </ol>
    </div>

    <script>
        async function forceTestData() {
            try {
                // MEMORY LEAK FIX: Add AbortController for request cleanup
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                }, 5000); // 5 second timeout
                
                try {
                    // Make a test network request to trigger data storage
                    const response = await fetch('https://httpbin.org/json', { 
                        method: 'GET',
                        signal: controller.signal
                    });
                    const data = await response.text();
                    
                    clearTimeout(timeoutId);
                    console.log('‚úÖ Test network request completed - should trigger extension storage');
                    updateStatus('Test network request sent. Check extension storage.');
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        console.log('üö´ Test request aborted due to timeout');
                        updateStatus('Test request timed out');
                    } else {
                        throw fetchError;
                    }
                }
            } catch (error) {
                console.error('‚ùå Test request failed:', error);
                updateStatus('Test request failed: ' + error.message);
            }
        }

        function forceErrorData() {
            try {
                // Generate a console error to trigger error storage
                throw new Error('Test error for IndexedDB debugging - ' + new Date().toISOString());
            } catch (error) {
                console.error('Test Error Generated:', error);
                updateStatus('Test console error generated. Check extension storage.');
            }
        }

        async function checkDatabase() {
            try {
                // Direct IndexedDB check
                const databases = await indexedDB.databases();
                console.log('üìä Available IndexedDB databases:', databases);
                
                // Try to open our specific database
                const request = indexedDB.open('DevToolsExtension', 2);
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    console.log('‚úÖ DevToolsExtension database found');
                    console.log('üìä Object stores:', Array.from(db.objectStoreNames));
                    updateStatus('Database found with stores: ' + Array.from(db.objectStoreNames).join(', '));
                    db.close();
                };
                
                request.onerror = (event) => {
                    console.error('‚ùå Failed to open DevToolsExtension database:', event);
                    updateStatus('Failed to open database: ' + event.toString());
                };
                
            } catch (error) {
                console.error('‚ùå Database check failed:', error);
                updateStatus('Database check failed: ' + error.message);
            }
        }

        function updateStatus(message) {
            const statusDiv = document.getElementById('status') || createStatusDiv();
            statusDiv.innerHTML = '<strong>Status:</strong> ' + message + ' <small>(' + new Date().toLocaleTimeString() + ')</small>';
        }

        function createStatusDiv() {
            const div = document.createElement('div');
            div.id = 'status';
            div.style.cssText = 'background: #fff3cd; border: 1px solid #ffc107; padding: 10px; margin: 10px 0; border-radius: 5px;';
            document.body.appendChild(div);
            return div;
        }

        // Auto-check on page load
        window.addEventListener('load', () => {
            setTimeout(checkDatabase, 1000);
        });
    </script>

    <div class="test">
        <h2>üí° What to Look For</h2>
        
        <h3>If Database Shows Up:</h3>
        <ul>
            <li>The issue was just lack of data</li>
            <li>Extension is working correctly</li>
            <li>Usage Card should show proper storage amounts</li>
        </ul>
        
        <h3>If Database Still Missing:</h3>
        <ul>
            <li>Check console for initialization errors</li>
            <li>Extension background script may not be running</li>
            <li>Our recent transaction validation changes may have broken initialization</li>
        </ul>
        
        <h3>Quick Fix Commands</h3>
        <p>If needed, try these in console:</p>
        <pre>// Force extension reload
chrome.runtime.reload()

// Check if extension is running
chrome.runtime.getManifest()</pre>
    </div>
</body>
</html>
