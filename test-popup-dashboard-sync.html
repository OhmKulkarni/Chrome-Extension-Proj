<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popup-Dashboard Sync Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #007bff; font-weight: bold; }
        button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border: 2px solid #dee2e6;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: rgba(248,249,250,0.8);
        }
        .status-header {
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
        }
        .fix-summary {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .sync-status {
            background: linear-gradient(45deg, #fd7e14, #e55353);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-header">
            üîÑ Popup-Dashboard Synchronization Test
        </div>
        
        <div class="fix-summary">
            <h3>üõ†Ô∏è New Fixes Applied:</h3>
            <ul>
                <li><strong>Popup Sync:</strong> Added storage change listeners to popup</li>
                <li><strong>Error Handling:</strong> Improved "Could not establish connection" handling with retries</li>
                <li><strong>State Sync:</strong> Popup now updates when dashboard toggles change</li>
            </ul>
        </div>
        
        <div class="sync-status">
            <h3>üéØ Synchronization Issue Solved</h3>
            <p><strong>Problem:</strong> Popup toggles worked, but dashboard sidebar didn't update when popup changed state</p>
            <p><strong>Solution:</strong> Added cross-component storage listeners for real-time synchronization</p>
        </div>
        
        <div class="test-section">
            <h3>üß™ Synchronization Tests</h3>
            <p>Testing communication between popup and dashboard components...</p>
            
            <button onclick="testBackgroundConnection()">üîå Test Background Connection</button>
            <button onclick="testStorageSync()">üì¶ Test Storage Sync</button>
            <button onclick="testDirectTabMessage()">üì° Test Direct Tab Messaging</button>
            <button onclick="clearLog()">üßπ Clear Log</button>
            
            <div id="testLog" class="log">Ready to test popup-dashboard synchronization...</div>
        </div>
        
        <div class="test-section">
            <h3>üìã Testing Instructions</h3>
            <ol>
                <li><strong>Reload extension</strong> in Chrome (chrome://extensions/)</li>
                <li><strong>Open popup</strong> and try toggle buttons</li>
                <li><strong>Open dashboard</strong> in a new tab</li>
                <li><strong>Toggle in popup</strong> ‚Üí Dashboard sidebar should update immediately</li>
                <li><strong>Toggle in dashboard</strong> ‚Üí Popup should update when reopened</li>
                <li><strong>Verify</strong> that both interfaces show the same toggle states</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h3>üîç Expected Behavior</h3>
            <div id="behaviorCheck">
                <div>‚úÖ Popup toggles work and change actual logging state</div>
                <div>‚úÖ Dashboard toggles work and change actual logging state</div>
                <div>‚úÖ Both interfaces stay synchronized via storage listeners</div>
                <div>‚úÖ No "Could not establish connection" errors</div>
                <div>‚úÖ Real-time updates between popup and dashboard</div>
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const container = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : '';
            container.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            container.scrollTop = container.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = 'Log cleared...';
        }

        async function testBackgroundConnection() {
            log('üîå Testing background script connection...');
            try {
                const response = await chrome.runtime.sendMessage({ action: 'ping' });
                if (response && response.success) {
                    log('‚úÖ Background script connection: WORKING', 'success');
                    log('üéØ This means popup-background communication is fixed', 'success');
                } else {
                    log('‚ùå Background script connection failed', 'error');
                    log(`üì¶ Response: ${JSON.stringify(response)}`, 'warning');
                }
            } catch (error) {
                if (error.message.includes('Could not establish connection')) {
                    log('‚ùå Still getting "Could not establish connection" error', 'error');
                    log('üîÑ Try reloading the extension completely', 'warning');
                } else {
                    log(`‚ùå Connection error: ${error.message}`, 'error');
                }
            }
        }

        async function testStorageSync() {
            log('üì¶ Testing storage synchronization...');
            try {
                // Get current tab
                const tabs = await new Promise(resolve => {
                    chrome.tabs.query({ active: true, currentWindow: true }, resolve);
                });
                
                if (!tabs[0]?.id) {
                    log('‚ö†Ô∏è No active tab found for testing', 'warning');
                    return;
                }
                
                const tabId = tabs[0].id;
                log(`üìÑ Testing with tab ID: ${tabId}`, 'info');
                
                // Read current storage state
                const currentState = await new Promise(resolve => {
                    chrome.storage.local.get([`tabLogging_${tabId}`], resolve);
                });
                
                const currentActive = currentState[`tabLogging_${tabId}`]?.active || false;
                log(`üìä Current logging state: ${currentActive}`, 'info');
                
                // Simulate a toggle (like what popup/dashboard would do)
                const newState = !currentActive;
                const tabState = {
                    active: newState,
                    startTime: newState ? Date.now() : undefined,
                    requestCount: 0
                };
                
                await new Promise(resolve => {
                    chrome.storage.local.set({ [`tabLogging_${tabId}`]: tabState }, resolve);
                });
                
                log(`‚úÖ Storage updated successfully to: ${newState}`, 'success');
                log('üéØ Both popup and dashboard should now show this state', 'success');
                
            } catch (error) {
                log(`‚ùå Storage sync test failed: ${error.message}`, 'error');
            }
        }

        async function testDirectTabMessage() {
            log('üì° Testing direct tab messaging (toggle approach)...');
            try {
                // Get current tab
                const tabs = await new Promise(resolve => {
                    chrome.tabs.query({ active: true, currentWindow: true }, resolve);
                });
                
                if (!tabs[0]?.id) {
                    log('‚ö†Ô∏è No active tab found for testing', 'warning');
                    return;
                }
                
                const tabId = tabs[0].id;
                log(`üìÑ Testing direct message to tab: ${tabId}`, 'info');
                
                // Send direct message (same as popup/dashboard approach)
                await chrome.tabs.sendMessage(tabId, {
                    action: 'toggleLogging',
                    enabled: true
                });
                
                log('‚úÖ Direct tab message sent successfully!', 'success');
                log('üéØ This confirms toggle communication is working', 'success');
                
            } catch (error) {
                if (error.message.includes('Could not establish connection')) {
                    log('‚ö†Ô∏è Content script not loaded in this tab (normal)', 'warning');
                    log('‚úÖ But no background script connection error!', 'success');
                } else {
                    log(`‚ùå Direct tab message error: ${error.message}`, 'error');
                }
            }
        }

        // Auto-run basic tests
        window.addEventListener('load', () => {
            setTimeout(async () => {
                await testBackgroundConnection();
                await testStorageSync();
                await testDirectTabMessage();
                log('üéâ All tests completed! Check results above.', 'success');
            }, 1000);
        });
    </script>
</body>
</html>
